angular.module("SunExercise",["SunExercise.controllers","SunExercise.directives","SunExercise.services"]).run(["APIProvider","MaterialProvider","ExerciseService","$rootScope","$q",function(k,h,e,l,b){var a=b.defer();k=a.promise;h.getRoot().then(function(b){a.resolve("done")},function(a,c){console.log("Error occurred while loading root material: "+c)});l.initResourcePromise=k}]).config(["$routeProvider",function(k){k.when("/root",{controller:"rootCtrl",templateUrl:"resources/partials/subject.html"}).when("/subject/:sid",
{controller:"subjectCtrl",templateUrl:"resources/partials/subject.html"}).when("/subject/:sid/chapter/:cid",{controller:"chapterCtrl",templateUrl:"resources/partials/chapter.html"}).when("/subject/:sid/chapter/:cid/lesson/:lid/activity/:aid",{controller:"activityCtrl",templateUrl:"resources/partials/activity.html"}).when("/achievements",{controller:"achievementsCtrl",templateUrl:"resources/partials/achievements.html"}).when("/achievements/awards/:aid",{controller:"awardsCtrl",templateUrl:"resources/partials/awards.html"}).otherwise({redirectTo:"/root"})}]);
angular.module("SunExercise.controllers",[]).controller("rootCtrl",["$location","MaterialProvider",function(k,h){h.getRoot().then(function(e){k.path("/subject/"+e.subjects[0].id)})}]).controller("subjectCtrl",function(){}).controller("chapterCtrl",function(){}).controller("lessonCtrl",function(){}).controller("activityCtrl",function(){}).controller("achievementsCtrl",function(){}).controller("awardsCtrl",function(){});
angular.module("SunExercise.directives",[]).directive("subject",["SandboxProvider","$routeParams","$location",function(k,h,e){var l=k.getSandbox();return{restrict:"E",link:function(b){b.initResourcePromise.then(function(a){console.log("Loading initial resources complete: "+a);if("undefined"===typeof h.sid)console.log("subject id is null");else{b.completeLoading=!0;a=l.getRootMaterial();var f=l.getSubjectMaterial(h.sid);b.subjects=a.subjects;b.chapters=f.chapters;b.title=f.title;var c=!1;b.showSubjectsNav=
function(){b.offsetWidth=c?"0":"25%";c=!c};b.loadProgress={};b.showProgress={};b.hasCached={};angular.forEach(f.chapters,function(a){l.getCurrentChapterStatus(a.id).then(function(c){b.hasCached[a.id]=c})});b.enterSubject=function(a){e.path("/subject/"+a)};b.enterChapter=function(a){b.hasCached[a]?e.path("/subject/"+h.sid+"/chapter/"+a):b.downloadResources(a)};b.downloadResources=function(a){b.showProgress[a]=!0;l.loadChapterResources(a).then(function(c){console.log("Loading resources complete: "+
c);b.hasCached[a]=!0},function(a){console.log("Error occured while loading chapter data: "+a)},function(c){b.loadProgress[a]=c})};b.enterAchievementCenter=function(){e.path("/achievements")}}},function(a){console.log(a)},function(a){b.progress=a})}}}]).directive("chapter",["SandboxProvider","$routeParams","$location",function(k,h,e){var l=k.getSandbox();return{restrict:"E",link:function(b,a){var f=l.getChapterMaterial(h.cid);b.title=f.title;b.lessons=f.lessons;for(var c={},d=0;d<f.lessons.length;d++)c[f.lessons[d].id]=
!1;angular.forEach(f.lessons,function(a,b){l.getLessonUserdata(a.id,f.id).then(function(b){b.is_complete&&(c[a.id]=!0)})});b.loadLesson=function(a){a=f.lessons[a];if("undefined"!=typeof a.requirements)for(var b=0;b<a.requirements.length;b++)if(!c[a.requirements[b]])return!1;return!0};b.showLockDialogue=function(a){$("#lessonModal-"+f.lessons[a].id).modal("toggle")};b.returnToSubject=function(){e.path("/subject/"+h.sid)}}}}]).directive("tree",["SandboxProvider","$http","$templateCache","$compile",
"$routeParams",function(k,h,e,l,b){var a=k.getSandbox();return{restrict:"E",link:function(f,c){for(var d=a.getChapterMaterial(b.cid),m=0;m<d.lessons.length&&d.lessons[m].id!=d.enter_lesson;m++);m>=d.lessons.length&&a.showNotification("error","\u6839\u636eenter_lesson\u627e\u4e0d\u5230\u5bf9\u5e94\u7684lesson");var g=chapterTreeDrawer.initChapterTree(d),e="<div class='chapter-tree-container'><table border='0' cellpadding='0' cellspacing='0'>";angular.forEach(g,function(a,c){e+="<tr>";angular.forEach(g[c],
function(a,b){e+="<td>";"string"==typeof g[c][b]?"I"==g[c][b]?e+="<div class='chapter-tree-line'><img src='resources/img/vertical-line.png' /></div>":"L"==g[c][b]?e+="<div class='chapter-tree-line'><img src='resources/img/long-vertical-line.png' /></div>":"*"==g[c][b]?e+="<div class='chapter-tree-line'><img src='resources/img/dot.png' /></div>":_.each(d.lessons,function(a,f){a.id==g[c][b]&&(e+='<lesson ng-if="loadLesson('+f+')" ng-init="lessonId=\''+a.id+'\'"></lesson><div ng-if="!loadLesson('+f+
')"><div class="lesson-button-container font-size-small"ng-click="showLockDialogue('+f+')"><div class="lesson-button-icon-locked"><img src="resources/img/lesson-button-icon-locked.png"/></div><span class="lesson-button-title">'+a.title+'</span></div><div class="modal fade" id="lessonModal-'+a.id+'"tabindex="-1"role="dialog"aria-labelledby="lessonModalLabel"aria-hidden="true"><div class="modal-dialog"><div class="lesson-container modal-content"><div class="lesson-header-locked"><img class="lesson-icon" src="resources/img/headerLocked.png"/><span class="lesson-title font-size-big">'+
a.title+'</span></div><div class="lesson-body-enter"><span>'+a.summary+'</span></div><div class="lesson-footer modal-footer"><button class="lesson-enter-button-locked col-md-4 col-md-offset-4">\u5f00\u59cb\u5b66\u4e60</button></div></div></div></div></div>')}):1==g[c][b]?e+="<div class='chapter-tree-right-line'><img src='resources/img/right-line.png' /></div>":2==g[c][b]?e+="<div class='chapter-tree-left-line'><img src='resources/img/left-line.png' /></div>":3==g[c][b]&&(e+="<div class='chapter-tree-line'><img src='resources/img/middle-line.png' /></div>");
e+="</td>"});e+="</tr>"});e+="</table></div>";c.html(e);l(c.contents())(f)}}}]).directive("lesson",["SandboxProvider","$location","$routeParams","$http","$q","$templateCache","$compile",function(k,h,e,l,b,a,f){var c=k.getSandbox(),d=StateMachine.create({initial:"welcome",events:[{name:"enter",from:"welcome",to:"learn"},{name:"resume",from:"welcome",to:"learn"},{name:"complete",from:"learn",to:"welcome"},{name:"back",from:"learn",to:"welcome"}],callbacks:{onwelcome:function(a,c,b){h.path("subject/"+
e.sid+"/chapter/"+e.cid)},onlearn:function(a,c,b,f,d){h.path("subject/"+e.sid+"/chapter/"+e.cid+"/lesson/"+f+"/activity/"+d)}}}),m=function(a,c){h.path("subject/"+e.sid+"/chapter/"+e.cid+"/lesson/"+a+"/activity/"+c)};return{restrict:"E",link:function(g,h){var n=c.loadUserInfo(),k,r;"undefined"!=typeof g.lessonId?(k=c.getLessonMaterial(g.lessonId,e.cid),r=c.getLessonUserdata(g.lessonId,e.cid),l.get("resources/partials/lesson.html",{cache:a}).success(function(a){h.html(a);f(h.contents())(g)})):(k=c.getLessonMaterial(e.lid,
e.cid),r=c.getLessonUserdata(e.lid,e.cid));var s,t;k.then(function(a){s=a});r.then(function(a){t=a});g.lessonState="locked";g.lessonIcon=g.lessonIconClass="lesson-button-icon-locked";g.lessonStateIcon="headerLocked";g.lessonStar="0";b.all([n,g.initResourcePromise,k,r]).then(function(){var a=s,b=t,f=c.getUserInfo();g.id=a.id;g.title=a.title;g.summary=a.summary;g.activities=a.activities;g.lessonIcon=b.is_complete&&"undefined"!=typeof b.summary.star?g.lessonIconClass="lesson-button-icon-star"+b.summary.star:
g.lessonIconClass="lesson-button-icon-unlocked";g.buttonMsg="undefined"===typeof b.current_activity?"\u5f00\u59cb\u5b66\u4e60":"\u7ee7\u7eed\u5b66\u4e60";g.showLessonDialogue=function(){$("#lessonModal-"+a.id).modal("toggle");if(b.is_complete){for(var c=0;c<a.activities.length;c++)"undefined"===typeof a.activities[c].redoable||a.activities[c].redoable||g.activities.splice(c,1);g.reviewLesson=!0;g.lessonState="review";g.lessonStateIcon="undefined"!=typeof b.summary.star?"lesson-header-star"+b.summary.star:
"headerUnlock"}else g.startLesson=!0,g.lessonState="unlocked",g.lessonStateIcon="headerUnlock"};g.enterActivity=function(c){$("#lessonModal-"+c).modal("hide");$(".modal-backdrop").remove();"undefined"===typeof b.current_activity?(b.current_activity=a.activities[0].id,d.enter(c,a.activities[0].id)):d.resume(c,b.current_activity)};g.reviewActivity=function(c,f){$("#lessonModal-"+a.id).modal("hide");$(".modal-backdrop").remove();"undefined"!==typeof b.activities[f].current_problem&&(b.activities[f].current_problem=
void 0);b.current_activity=f;d.resume(c,f)};g.backToChapter=function(){d.back()};g.$on("pauseActivity",function(a){console.log("hit");d.back()});g.$on("lesson.complete",function(a){c.getIncompleteGlobalBadges(a).then(function(a){for(var f={correct_percent:b.summary.correct_percent},d=0;d<a.length;d++){var g="undefined"!=typeof a[d].condition?c.getGrader(a[d].id,a[d].condition):c.getGrader(a[d].id,"");c.createGrader(g,f)&&c.addAchievements("badges",a[d])}})});g.$on("endOfLesson",function(d,e){"undefined"!==
typeof e&&"undefined"!==typeof e.summary&&"undefined"!==typeof e.summary.correct_count&&(b.summary.correct_count=e.summary.correct_count,b.summary.correct_percent=e.summary.correct_percent);b.current_activity=void 0;"undefined"==typeof b.summary.correct_percent?(b.summary.correct_percent=100,b.is_complete=!0):"undefined"!=typeof a.pass_score?c.parseCompleteCondition(a.pass_score,b.summary)&&(b.is_complete=!0):b.is_complete=!0;if(e.should_transition){if("undefined"!=typeof b.summary.correct_percent)if("undefined"==
typeof a.star3||b.summary.correct_percent>=a.star3)b.summary.star=3;else if("undefined"==typeof a.star2||b.summary.correct_percent>=a.star2)b.summary.star=2;else if("undefined"==typeof a.star2||b.summary.correct_percent>=a.star1)b.summary.star=1;if(b.is_complete&&"undefined"!=typeof a.achievements)for(var m=0;m<a.achievements.length;m++)"award"==a.achievements[m].type&&"undefined"==typeof f.achievements.awards[a.achievements[m].id]&&("undefined"==typeof b.summary.correct_count?c.conditionParser(a.achievements[m].condition,
Infinity,100):c.conditionParser(a.achievements[m].condition,b.summary.correct_count,b.summary.correct_percent))&&c.addAchievements("awards",a.achievements[m]);c.sendEvent("lesson.complete",g);c.flushUserdata(a.id);g.hasFinalQuiz="undefined"!=typeof b.summary.correct_count;g.lessonCorrectPercent=b.summary.correct_percent;g.lessonStar="undefined"!=typeof b.summary.star?b.summary.star:0;g.lessonCup=1==b.summary.star?" \u83b7\u5f97 \u94dc\u676f":2==b.summary.star?" \u83b7\u5f97 \u94f6\u676f":3==b.summary.star?
" \u83b7\u5f97 \u91d1\u676f":null;g.showLessonSummary=!0}});angular.forEach(a.activities,function(d,e){g.$on("activityComplete_"+d.id,function(d,n){"undefined"!==typeof n&&"undefined"!==typeof n.summary&&"undefined"!==typeof n.summary.correct_count&&(b.summary.correct_count=n.summary.correct_count,b.summary.correct_percent=n.summary.correct_percent);if(e!=a.activities.length-1)"undefined"!==typeof n&&"undefined"!==typeof n.activity?(b.current_activity=n.activity,n.should_transition&&(c.flushUserdata(a.id),
m(a.id,n.activity))):(b.current_activity=a.activities[e+1].id,n.should_transition&&(c.flushUserdata(a.id),m(a.id,a.activities[e+1].id)));else if(b.current_activity=void 0,n.should_transition){"undefined"==typeof b.summary.correct_percent?(b.summary.correct_percent=100,b.is_complete=!0):"undefined"!=typeof a.pass_score?c.parseCompleteCondition(a.pass_score,b.summary)&&(b.is_complete=!0):b.is_complete=!0;if("undefined"!=typeof b.summary.correct_percent)if("undefined"==typeof a.star3||b.summary.correct_percent>=
a.star3)b.summary.star=3;else if("undefined"==typeof a.star2||b.summary.correct_percent>=a.star2)b.summary.star=2;else if("undefined"==typeof a.star2||b.summary.correct_percent>=a.star1)b.summary.star=1;if(b.is_complete&&"undefined"!=typeof a.achievements)for(var h=0;h<a.achievements.length;h++)"award"==a.achievements[h].type&&"undefined"==typeof f.achievements.awards[a.achievements[h].id]&&("undefined"==typeof b.summary.correct_count?c.conditionParser(a.achievements[h].condition,Infinity,100):c.conditionParser(a.achievements[h].condition,
b.summary.correct_count,b.summary.correct_percent))&&c.addAchievements("awards",a.achievements[h]);c.sendEvent("lesson.complete",g);c.flushUserdata(a.id);g.hasFinalQuiz="undefined"!=typeof b.summary.correct_count;g.lessonCorrectPercent=b.summary.correct_percent;g.lessonStar="undefined"!=typeof b.summary.star?b.summary.star:0;g.lessonCup=1==b.summary.star?" \u83b7\u5f97 \u94dc\u676f":2==b.summary.star?" \u83b7\u5f97 \u94f6\u676f":3==b.summary.star?" \u83b7\u5f97 \u91d1\u676f":null;g.showLessonSummary=
!0}})})})}}}]).directive("review",function(){return{restrict:"E",templateUrl:"resources/partials/_showAllActivities.html"}}).directive("activity",["SandboxProvider","$routeParams","$compile",function(k,h,e){var l=k.getSandbox();return{restrict:"E",link:function(b,a){var f=l.getActivityUserdata(h.aid),c=l.getActivityMaterial(h.aid,f.seed),d=l.getUserInfo();b.activityTitle=c.title;b.body=e("<div>"+c.body+"</div>")(b);b.activityId=c.id;if("quiz"===c.type){for(var m=0,g=0;g<c.problems.length;g++)if("undefined"!=
f.current_problem&&f.current_problem==c.problems[g].id){m=g;break}b.problems=c.problems.slice(m);b.problemIndex=m;b.progressWidth=100*(m+1)/c.problems.length}b.$on("activityStart",function(a){f.start_time=Date.now()});b.pauseLearn=function(){l.sendEvent("pauseActivity",b)};"undefined"!=typeof f.is_complete&&f.is_complete&&(f=l.resetUserdata("activity",c.id));"quiz"===c.type?(f.start_time=Date.now(),b.hideContinueButton=!0,angular.forEach(c.problems,function(a,e){b.$on("problemComplete_"+a.id,function(a,
m){if(e!=c.problems.length-1)f.current_problem=c.problems[e+1].id;else{f.current_problem=void 0;f.is_complete=!0;var g=Date.now(),h=g-f.start_time;"undefined"==typeof f.duration&&(f.end_time=g,f.duration=h);for(var k=0,g=0;g<c.problems.length;g++)f.problems[c.problems[g].id].is_correct&&k++;f.summary.correct_count=k;f.summary.correct_percent=parseInt(100*k/c.problems.length);var q={};"undefined"!==typeof c.is_final&&c.is_final&&(q.correct_count=k,q.correct_percent=parseInt(100*k/c.problems.length));
if("undefined"!=typeof c.achievements)for(g={correct_count:f.summary.correct_count,correct_percent:f.summary.correct_percent,duration:f.duration},h=0;h<c.achievements.length;h++)if("undefined"==typeof d.achievements.badges[c.achievements[h].id]){var p="undefined"!=typeof c.achievements[h].condition?l.getGrader(c.achievements[h].id,c.achievements[h].condition):l.getGrader(c.achievements[h].id,"");l.createGrader(p,g)&&l.addAchievements("badges",c.achievements[h])}}m.should_transition?e==c.problems.length-
1?"undefined"==typeof c.show_summary||!c.show_summary||c.show_summary&&b.showQuizSummary?l.completeQuizActivity(c,b,k,q):"undefined"!=typeof c.show_summary&&c.show_summary&&(l.completeQuizActivity(c,b,k,q),b.showQuizSummary=!0,b.hideContinueButton=!0,b.quizCorrectCount=k,b.totalProblemsNum=c.problems.length,b.quizCorrectPercent=parseInt(100*k/b.totalProblemsNum)+"%",b.nextActivity=function(){l.completeQuizActivity(c,b,k,q)}):(PageTransitions.nextPage(10,$("#buttonContainer")),b.progressWidth=100*
(e+2)/c.problems.length):e==c.problems.length-1&&l.completeQuizActivity(c,b,k,q)})})):(b.lecture=!0,f.start_time=Date.now(),b.continueActivity=function(){f.end_time=Date.now();f.is_complete=!0;if("undefined"!=typeof c.achievements)for(var a=0;a<c.achievements.length;a++)if("undefined"==typeof d.achievements.badges[c.achievements[a].id]){var e="undefined"!=typeof c.achievements[a].condition?l.getGrader(c.achievements[a].id,c.achievements[a].condition):l.getGrader(c.achievements[a].id,"");l.createGrader(e,
"")&&l.addAchievements("badges",c.achievements[a])}if("undefined"!=typeof c.jump)for(a=0;a<c.jump.length;a++)e=c.jump[a].split(":"),"force_to_activity"==e[0]&&l.sendEvent("activityComplete_"+c.id,b,{activity:e[1],should_transition:!0});else l.sendEvent("activityComplete_"+c.id,b,{should_transition:!0})})}}}]).directive("xvideo",["APIProvider","$compile","$routeParams",function(k,h,e){var l=function(b){b.requestFullscreen?b.requestFullscreen():b.mozRequestFullScreen?b.mozRequestFullScreen():b.webkitRequestFullscreen&&
b.webkitRequestFullscreen()};return{restrict:"E",link:function(b,a,f){f="<video id='video' class='xvideo' src='"+k.getAPI("getFileResources",{chapterId:e.cid,lessonId:e.lid},"")+"/"+f.src+"' controls></video><br><button class='play-button' ng-click='playVideo()'>{{ playButtonMsg }}</button>";a.html(f);h(a.contents())(b);var c=!1,d=0,m=a.contents()[0];b.playButtonMsg="\u64ad \u653e";b.playVideo=function(){!0==m.paused?(b.playButtonMsg="\u6682 \u505c",b.$emit("activityStart"),c?(m.src=m.currentSrc,
m.load(),l(m),m.play()):(l(m),m.play(),c=!0)):(m.pause(),b.playButtonMsg="\u64ad \u653e")};m.addEventListener("webkitfullscreenchange",function(){console.log("\u54cd\u5e94\uff01wekit:"+document.webkitIsFullScreen);document.webkitIsFullScreen||(d=m.currentTime,console.log("\u9000\u51fa\uff1a"+d),m.pause(),b.playButtonMsg="\u64ad \u653e")});m.addEventListener("canplay",function(){m.currentTime=d;console.log("start="+c+"  \u8fdb\u6765: "+m.currentTime+"cut="+d)})}}}]).directive("xaudio",["APIProvider",
"$compile","$routeParams",function(k,h,e){return{restrict:"E",link:function(l,b,a){a="<audio class='xaudio' src='"+k.getAPI("getFileResources",e.lid,"")+a.src+"' controls></audio>";b.html(a);h(b.contents())(l)}}}]).directive("ximage",["APIProvider","$compile","$routeParams",function(k,h,e){return{restrict:"E",link:function(l,b,a){a="<img class='ximage' src='"+k.getAPI("getFileResources",e.lid,"")+a.src+"' />";b.html(a);h(b.contents())(l)}}}]).directive("xpdf",["APIProvider","$compile","$routeParams",
function(k,h,e){return{restrict:"E",link:function(l,b,a){function f(a){c.getPage(a).then(function(a){var b=a.getViewport(m);g.height=b.height;g.width=b.width;a.render({canvasContext:p,viewport:b})})}b.html("<div id='xpdf'><canvas id='the-canvas' border='1px solid black'></canvas></div><button class='xpdf-button' ng-click='goPrevious()'>\u4e0a\u4e00\u9875</button><button class='xpdf-button' ng-click='goNext()'>\u4e0b\u4e00\u9875</button><button ng-click='fullscreen()'>\u5168\u5c4f\u6a21\u5f0f</button>");
h(b.contents())(l);l.$emit("activityStart");PDFJS.disableWorker=!0;var c=null,d=1,m=0.8,g=b.contents()[0].children[0],p=g.getContext("2d");l.goPrevious=function(){1>=d||(d--,f(d))};l.goNext=function(){d>=c.numPages||(d++,f(d))};l.fullscreen=function(){var a=b.contents()[0];m="pafe-fit";a.webkitRequestFullScreen()};l=k.getAPI("getFileResources",{chapterId:e.cid,lessonId:e.lid},"")+"/"+a.src;console.log("pdf url:"+l);PDFJS.getDocument(l).then(function(a){c=a;f(d)})}}}]).directive("switch",["$timeout",
function(k){return{link:function(h,e){k(function(){PageTransitions.initParams(e)},0)}}}]).directive("problem",["SandboxProvider","$compile","$http","$templateCache",function(k,h,e,l){var b=k.getSandbox();return{restrict:"E",link:function(a,f){var c=a.problem,d=b.getUserdata(c.id),m=b.getParentActivityData(c.parent_id);e.get("resources/partials/choiceTemplates/_"+c.type+"Template.html",{cache:l}).success(function(b){f.html(b);h(f.contents())(a)});d.enter_time=Date.now();a.answer={};a.submitIcon="submitDisable";
0<d.answer.length&&(a.submitted=!0);if("undefined"!==typeof m.show_answer&&m.show_answer){if("singlefilling"!=c.type){a.correct_answers=[];for(var g=0;g<c.choices.length;g++)c.choices[g].is_correct&&a.correct_answers.push(String.fromCharCode(65+g));a.correct_answers=a.correct_answers.join(",")}else a.correct_answers=c.correct_answer;a.explanation=c.explanation}a.calcChoiceNum=function(a){return String.fromCharCode(65+a)+"."};"undefined"!==typeof c.hint&&(d.is_hint_checked=!1,a.hint=c.hint,a.showHintButton=
!0,a.showHint=function(){a.showHintBox=!0;d.is_hint_checked=!0});"undefined"!=typeof c.layout&&"card"==c.layout?(a.layout="card",a.colNum="6"):(a.layout="list",a.colNum="12");a.type="singlechoice"==c.type?"\u5355\u9009\u9898":"multichoice"==c.type?"\u591a\u9009\u9898":"\u5355\u586b\u7a7a\u9898";a.body=h("<div>"+c.body+"</div>")(a);if("singlefilling"!=c.type)for(a.choiceBody={},g=0;g<c.choices.length;g++)a.choiceBody[c.choices[g].id]=h("<div>"+c.choices[g].body+"</div>")(a);if("singlefilling"!=c.type){a.checked=
[];for(g=0;g<c.choices.length;g++)a.checked.push("default");a.lastChecked=-1;g=function(b,f){a.submitted||(a.submitIcon="submit",-1!=a.lastChecked&&(a.checked[a.lastChecked]="default"),a.checked[f]="choose",a.lastChecked=f,a.answer[c.id]=b)};a.chosenNum=0;var k=function(b,c){a.submitted||(a.submitIcon="submit","choose"==a.checked[c]?(a.checked[c]="default",a.answer[b]=!1,a.chosenNum--):(a.checked[c]="choose",a.answer[b]=!0,a.chosenNum++),0==a.chosenNum&&(a.submitIcon="submitDisable"))};"singlechoice"==
c.type?a.chooseOption=g:"multichoice"==c.type?a.chooseOption=k:"singlefilling"==c.type&&console.log("hit")}else a.problemResult="default",a.writeAnswer=function(b){a.submitIcon="undefined"!=typeof b&&0<b.length?"submit":"submitDisable"};a.hasExplanation=function(){return"undefined"!=typeof c.explanation};a.submitAnswer=function(){d.submit_time=Date.now();a.submitted=!0;"undefined"!==typeof c.hint&&a.showHintBox&&(a.showHintBox=!1);if(null!==a.answer)if("multichoice"===c.type){d.is_correct=b.problemGrader(c,
a.answer);d.is_correct?b.playSoundEffects("correct"):b.playSoundEffects("wrong");for(var f=0;f<c.choices.length;f++)"undefined"!==typeof a.answer[c.choices[f].id]&&a.answer[c.choices[f].id]&&d.answer.push(c.choices[f].id)}else"undefined"!==typeof a.answer[c.id]&&(d.is_correct=b.problemGrader(c,a.answer),d.is_correct?b.playSoundEffects("correct"):b.playSoundEffects("wrong"),d.answer.push(a.answer[c.id]));if("undefined"!==typeof m.show_answer&&m.show_answer){a.showExplanation=!0;a.hideSubmitButton=
!0;a.showContinueButton=!0;if("singlefilling"!=c.type)for(f=0;f<c.choices.length;f++)if(c.choices[f].is_correct)a.checked[f]="correct";else{if("singlechoice"==c.type&&a.answer[c.id]==c.choices[f].id||"multichoice"==c.type&&a.answer[c.choices[f].id])a.checked[f]="wrong"}else a.problemResult=d.is_correct?"success":"error";b.sendEvent("problemComplete_"+c.id,a,{should_transition:!1})}else b.sendEvent("problemComplete_"+c.id,a,{should_transition:!0})};a.continueProblem=function(){b.sendEvent("problemComplete_"+
c.id,a,{should_transition:!0})}}}}]).directive("mathjaxBind",function(){return{restrict:"A",controller:["$scope","$element","$attrs",function(k,h,e){setTimeout(function(){k.$apply(function(){k.$watch(e.mathjaxBind,function(e){h.html(void 0==e?"":e);MathJax.Hub.Queue(["Typeset",MathJax.Hub,h[0]])})})},0)}]}}).directive("achievements",["SandboxProvider","$q","$location",function(k,h,e){var l=k.getSandbox();return{restrict:"E",link:function(b){var a={},f=l.getAchievementsMaterial();f.then(function(b){a=
b},function(a){console.log("Error occurred while loading achievments json: "+a)});var c={},d=l.loadUserInfo();d.then(function(){c=l.getUserInfo()},function(a){console.log("Error occurred while loading userinfo data: "+a)});h.all([b.initResourcePromise,f,d]).then(function(){b.completeDownload=!0;b.badges=a.badges;b.awards=a.awards;b.badgeName={};b.badgeStatus={};b.awardName={};if("undefined"!=typeof c.achievements.badges){for(var f=0,d=0;d<b.badges.length;d++)"undefined"!=typeof c.achievements.badges[b.badges[d].id]?
(b.badgeName[b.badges[d].id]=b.badges[d].id,b.badgeStatus[b.badges[d].id]="unlocked",f++):(b.badgeName[b.badges[d].id]="unknown-badge",b.badgeStatus[b.badges[d].id]="locked");b.currentBadges=f}if("undefined"!=typeof c.achievements.awards){for(d=f=0;d<b.awards.length;d++)"undefined"!=typeof c.achievements.awards[b.awards[d].id]?(b.awardName[b.awards[d].id]=b.awards[d].id,f++):b.awardName[b.awards[d].id]="unknown-award";b.currentAwards=f}$("#achievementTab a").click(function(a){a.preventDefault();$(this).tab("show")});
b.enterAward=function(a){e.path("/achievements/awards/"+a)};b.returnToSubject=function(){e.path("/root")}},function(a){console.log("Error occurred while loading achievements resources: "+a)})}}}]).directive("award",["SandboxProvider","APIProvider","$routeParams","$location",function(k,h,e,l){var b=k.getSandbox();return{restrict:"E",link:function(a){var f=e.aid;b.getAchievementsMaterial().then(function(b){for(var d=0;d<b.awards.length;d++)if(b.awards[d].id==f){a.title=b.awards[d].title;a.url=b.awards[d].url;
break}},function(a){console.log("Error occurred while loading achievments json: "+a)});a.returnToAchievements=function(){l.path("/achievements")}}}}]);
angular.module("SunExercise.services",[]).factory("DataProvider",function(){return{rootMaterial:{},userinfoMaterial:{},Material:{},materialMap:{},achievements:{ts:"1",badges:[{id:"first_golden_cup",title:"\u91d1\u676f\u5956",desc:"\u4f60\u7684\u7b2c\u4e00\u5ea7\u91d1\u676f\uff01",condition:[80],scope:"lesson.complete"},{id:"lecture_finish",title:"\u8ba4\u771f\u542c\u8bb2",desc:"\u8ba4\u771f\u542c\u8bb2\u53ef\u4ee5\u8ba9\u4f60\u66f4\u9ad8\u6548\u5730\u638c\u63e1\u6240\u5b66\u77e5\u8bc6\u3002"},{id:"practice_finish",
title:"\u8fb9\u5b66\u8fb9\u7ec3",desc:"\u770b\u5b8c\u89c6\u9891\u9a6c\u4e0a\u7ec3\u4e60\u6709\u52a9\u4e8e\u5de9\u56fa\u77e5\u8bc6\uff0c\u7ee7\u7eed\u52a0\u6cb9\u54e6~"},{id:"practice_all_correct",title:"\u4e00\u542c\u5c31\u61c2",desc:"\u597d\u5389\u5bb3\uff01\u7b2c\u4e00\u6b21\u5b66\u5c31\u5168\u5bf9\u4e86\uff01\u4fdd\u6301\u8fd9\u4e2a\u72b6\u6001\u54e6~"},{id:"practice_fast_and_correct",title:"\u53c8\u5feb\u53c8\u51c6",desc:"\u4e0d\u4ec5\u5168\u5bf9\uff0c\u8fd8\u5b8c\u6210\u5f97\u8fd9\u4e48\u5feb\uff01\u4f60\u771f\u662f\u592a\u5389\u5bb3\u4e86\u3002"},
{id:"golden_cup",title:"\u72ec\u5b64\u6c42\u8d25",desc:"\u8ba9\u96be\u9898\u6765\u5f97\u66f4\u731b\u70c8\u4e9b\u5427\uff01"},{id:"final_quiz_failed",title:"\u8001\u5e08\u5728\u7b49\u4f60",desc:"\u4e0d\u8981\u6c14\u9981\uff0c\u5b66\u4e60\u6700\u91cd\u8981\u7684\u662f\u6001\u5ea6\u548c\u575a\u6301\u3002\u52a0\u6cb9\uff0c\u6211\u770b\u597d\u4f60\uff01"}],awards:{}}}}).factory("APIProvider",["DataProvider",function(k){return{getAPI:function(h,e,l){switch(h){case "getRoot":return"/apps?package_name=org.sunlib.exercise&type=chapter&type=subject";
case "getInitResources":return"/exercise/v1/resources";case "getChapterResources":return"/exercise/v1/chapters/"+e;case "getLessonJson":return"undefined"===typeof e.chapter&&console.log("chapter is null"),""+e.chapter.url+"/"+e.lessonId+"/lesson.json";case "getFileResources":return""+k.materialMap[e.chapterId].url+"/"+e.lessonId;case "getAchievementsJson":return"/exercise/v1/achievements?ts="+l;case "getAchievementsResources":return"/exercise/v1/achievements";case "getLessonUserdata":return"/exercise/v1/user_data/lessons/"+
e;case "postLessonUserdata":return"/exercise/v1/user_data/lessons/"+e;case "getUserInfo":return"/exercise/v1/user_data/user_info";case "postUserInfoUserdata":return"/exercise/v1/user_data/user_info"}return!1}}}]).factory("ExerciseService",["$q","$http","$timeout",function(k,h,e){var l=function(b,a){var f=k.defer(),c=f.promise,d=h.get(a+"?ts="+b+"&act=status");d.success(function(a){a.is_cached?f.resolve("done"):f.resolve(a.progress)});d.error(function(a){f.reject("Error occured while getting the current status: "+
a)});return c};return{emitEvent:function(b,a,f){a.$emit(b,f)},getServerResources:function(b,a){var f=k.defer(),c=f.promise,d=h.get(b+"?ts="+a+"&act=status");d.success(function(c){"undefined"==typeof c.is_cached||"undefined"!=typeof c.is_cached&&!c.is_cached?h.get(b+"?ts="+a+"&act=cache").success(function(c){"506"==c?f.reject("Server Offline"):(f.notify(c.progress),e(function n(){l(a,b).then(function(a){"done"!=a?(f.notify(a),e(n,500)):(f.notify(100),f.resolve("complete"))})},500))}):c.is_cached&&
f.resolve("already in cache")});d.error(function(a){f.reject("Requesting current resources status error: "+a)});return c},showNotification:function(b,a){toastr.options.positionClass="toast-top-full-width";"success"==b?toastr.success('<img src="resources/img/badge-icons/'+a.id+'.png"/> \u606d\u559c\u4f60\u83b7\u5f97\u4e86 '+a.title+" \u5fbd\u7ae0\uff01"):"error"==b&&toastr.error("\u9519\u8bef\uff1a"+a)}}}]).factory("MaterialProvider",["$http","$q","$timeout","ExerciseService","APIProvider","DataProvider",
function(k,h,e,l,b,a){var f=a.rootMaterial,c=a.userinfoMaterial,d=a.Material,m=a.materialMap,g=function(a,b){for(var c=[],f=0,d=a.problems.length;f<d;f++)c.push(f);for(var f=[],d=0,e=b.length;d<e;d++){var g=parseInt(b[d]*(e-d));f.push(a.problems[c[g]]);c.splice(g,1)}return f},p=function(){var b=h.defer(),c=b.promise;b.resolve(a.achievements);return c};return{getRoot:function(){var a=h.defer(),c=a.promise,d=k.get(b.getAPI("getRoot","",""));d.success(function(b){var c=_.filter(b,function(a){return"chapter"===
a.type});f.subjects=[];var d={};b=_.map(_.filter(b,function(a){return"subject"===a.type}),function(a){a.chapters=[];m[a.id]=a;f.subjects.push(a);return d[a.subject]=a});_.each(c,function(a){d[a.subject].chapters.push(a);m[a.id]=a;_.each(a.lessons,function(b){b.chapterId=a.id;m[b.id]=b})});f.subjects=b;a.resolve(f)});d.error(function(b,c){a.reject("Load Root Data Error: "+c)});return c},getRootMaterial:function(){return f},loadUserInfo:function(){var a=h.defer(),f=a.promise,d=k.get(b.getAPI("getUserInfo",
""));d.success(function(b){c=b;"undefined"==typeof c.achievements?c={achievements:{badges:{},awards:{}}}:"undefined"==typeof c.achievements.badges&&(c.achievements={badges:{},awards:{}});a.resolve("Loading user info successful!")});d.error(function(b){a.reject("Error occured while loading userInfo: "+b)});return f},getUserInfo:function(){return c},getSubjectMaterial:function(a){return m[a]},getCurrentChapterStatus:function(a){a=h.defer();var b=a.promise;a.resolve(!0);return b},loadChapterResources:function(a){var c=
h.defer(),f=c.promise,d=m[a].ts;l.getServerResources(b.getAPI("getChapterResources",a,""),d).then(function(a){c.resolve(a)},function(a,b){c.reject(b)},function(a){c.notify(a)});return f},getChapterMaterial:function(a){return m[a]},getLessonMaterial:function(a,c){console.log("get lesson json,%s,%s",c,a);var f=h.defer(),e=f.promise,g=k.get(b.getAPI("getLessonJson",{chapter:m[c],lessonId:a},""));g.success(function(a){d=a;for(a=0;a<d.activities.length;a++){"undefined"!=typeof d.activities[a].randomize_problems&&
d.activities[a].randomize_problems&&"undefined"==typeof d.activities[a].pool_count&&(d.activities[a].problems=_.shuffle(d.activities[a].problems));if("undefined"!=typeof d.activities[a].randomize_choices&&d.activities[a].randomize_choices)for(var b=0;b<d.activities[a].problems.length;b++)d.activities[a].problems[b].choices=_.shuffle(d.activities[a].problems[b].choices);m[d.activities[a].id]=d.activities[a]}m[d.id]=d;f.resolve(d)});g.error(function(b,d){console.log("get lesson json failed,%s,%s",c,
a);f.reject("Load Lesson Data Error: "+d)});return e},getActivityMaterial:function(a,b){var c=this.getMaterial(a);if("undefined"!=typeof c.pool_count)if(c=_.clone(this.getMaterial(a)),"undefined"!=typeof b){var f=g(c,b);c.problems=f;c.seed=b}else{for(var d=[],f=0;f<c.pool_count;f++)d.push(Math.random());f=g(c,d);c.problems=f;c.seed=d.slice()}return c},getAchievementsMaterial:p,loadAchievementsResources:function(a){var c=h.defer(),f=c.promise;l.getServerResources(b.getAPI("getAchievementsResources",
"",""),a).then(function(a){c.resolve(a)},function(a){c.reject("Error occurred while loading achievements resources: "+a)},function(a){c.notify(a)});return f},getIncompleteGlobalBadges:function(a){var b=h.defer(),f=b.promise,d=c,e=[];p().then(function(c){if("undefined"!=typeof c.badges)for(var f=0;f<c.badges.length;f++)"undefined"!=typeof c.badges[f].scope&&c.badges[f].scope==a.name&&"undefined"==typeof d.achievements.badges[c.badges[f].id]&&e.push(c.badges[f]);b.resolve(e)},function(a){b.reject(a)});
return f},getMaterial:function(a){return m[a]}}}]).factory("UserdataProvider",["MaterialProvider","$q","$http","APIProvider","ExerciseService",function(k,h,e,l,b){var a={};return{getLessonUserdata:function(b,c){var d=h.defer(),m=d.promise;if("undefined"!=typeof a[b])return d.resolve(a[b]),m;var g=e.get(l.getAPI("getLessonUserdata",b,""));g.success(function(e,g){if("undefined"!=typeof e.summary){a[b]=e;var h=k.getLessonMaterial(b,c);h.then(function(b){for(var c=0;c<b.activities.length;c++)if(a[b.activities[c].id]=
e.activities[b.activities[c].id],"quiz"==e.activities[b.activities[c].id].type)for(var f=0;f<b.activities[c].problems.length;f++)a[b.activities[c].problems[f].id]=e.activities[b.activities[c].id].problems[b.activities[c].problems[f].id]});d.resolve(a[b])}else"undefined"==typeof e.summary&&200==g&&(a[b]={is_complete:!1,activities:{},summary:{badges:[]}},h=k.getLessonMaterial(b,c),h.then(function(c){for(var e=0;e<c.activities.length;e++)"quiz"===c.activities[e].type?(a[b].activities[c.activities[e].id]=
a[c.activities[e].id]={is_complete:!1,problems:{},summary:{}},"undefined"!=typeof c.activities[e].pool_count&&(a[b].activities[c.activities[e].id].seed=a[c.activities[e].id].seed=[])):a[b].activities[c.activities[e].id]=a[c.activities[e].id]={summary:{}};d.resolve(a[b])}))});g.error(function(a){d.reject("Error occurred while loading userdata from turtle server: "+a)});return m},getActivityUserdata:function(b){var c=k.getMaterial(b);if("undefined"!=typeof c.pool_count){if("undefined"!=typeof a[b].seed&&
0==a[b].seed.length){c=k.getActivityMaterial(b);a[b].seed=c.seed;for(var d=0;d<c.problems.length;d++)a[b].problems[c.problems[d].id]=a[c.problems[d].id]={is_correct:!1,answer:[]}}}else if("quiz"===c.type&&"undefined"==typeof a[c.problems[0].id])for(d=0;d<c.problems.length;d++)a[c.problems[d].id]=a[b].problems[c.problems[d].id]={is_correct:!1,answer:[]};return a[b]},getUserdata:function(b){return a[b]},resetUserdata:function(b,c){if("lesson"===b)this.getLessonUserdata(c).then(function(a){return a});
else{if("activity"===b){var d=k.getMaterial(c);a[c]={is_complete:!0,summary:{badges:[]}};a[d.parent_id].activities[c]=a[c];if("quiz"===d.type){a[c].problems={};"undefined"!=typeof d.pool_count&&(a[c].seed=[]);for(var e=0;e<d.problems.length;e++)a[c].problems[d.problems[e].id]={is_correct:!1,answer:[]},a[d.problems[e].id]=a[c].problems[d.problems[e].id]}}else a[c]={is_correct:!1,answer:[]};return a[c]}},flushUserdata:function(b){e({method:"POST",url:l.getAPI("postLessonUserdata",b,""),headers:{"Content-Type":"application/json;charset=UTF-8"},
data:JSON.stringify(a[b])})},addAchievements:function(f,c){var d;"undefined"==typeof a.user_info&&(a.user_info={achievements:{badges:{},awards:{}}});d=a.user_info;var h="undefined"==typeof d.achievements[f][c.id];d.achievements[f][c.id]={time:Date.now()};h&&e.post(l.getAPI("postUserInfoUserdata","",""),JSON.stringify(a.user_info));b.showNotification("success",c)}}}]).factory("GraderProvider",function(){var k={first_golden_cup:function(h){return function(e){return e.correct_percent>=h[0]}},lecture_finish:function(){return function(){return!0}},
practice_finish:function(){return function(){return!0}},practice_all_correct:function(h){return function(e){return e.correct_percent==h[0]}},practice_fast_and_correct:function(h){return function(e){return e.correct_percent==h[0]&&e.duration<=1E3*h[2]}},golden_cup:function(h){return function(e){return e.correct_percent>=h[0]}},final_quiz_failed:function(h){return function(e){return e.correct_percent<h[0]&&e.duration<=1E3*h[2]}}};return{getGrader:function(h,e){return k[h](e)},graderFactory:function(h,
e){return h(e)}}}).factory("SandboxProvider",["MaterialProvider","UserdataProvider","GraderProvider","ExerciseService",function(k,h,e,l){function b(){b.prototype.getRootMaterial=function(){return k.getRootMaterial()};b.prototype.loadUserInfo=function(a){return k.loadUserInfo(a)};b.prototype.getUserInfo=function(){return k.getUserInfo()};b.prototype.getSubjectMaterial=function(a){return k.getSubjectMaterial(a)};b.prototype.getCurrentChapterStatus=function(a){return k.getCurrentChapterStatus(a)};b.prototype.loadChapterResources=
function(a){return k.loadChapterResources(a)};b.prototype.getChapterMaterial=function(a){return k.getChapterMaterial(a)};b.prototype.getLessonMaterial=function(a,b){return k.getLessonMaterial(a,b)};b.prototype.getActivityMaterial=function(a,b){return k.getActivityMaterial(a,b)};b.prototype.getAchievementsMaterial=function(){return k.getAchievementsMaterial()};b.prototype.loadAchievementsResources=function(a){return k.loadAchievementsResources(a)};b.prototype.getIncompleteGlobalBadges=function(a){return k.getIncompleteGlobalBadges(a)};
b.prototype.addAchievements=function(a,b){return h.addAchievements(a,b)};b.prototype.getLessonUserdata=function(a,b){return h.getLessonUserdata(a,b)};b.prototype.getActivityUserdata=function(a){return h.getActivityUserdata(a)};b.prototype.getUserdata=function(a){return h.getUserdata(a)};b.prototype.flushUserdata=function(a){return h.flushUserdata(a)};b.prototype.resetUserdata=function(a,b){return h.resetUserdata(a,b)};b.prototype.getParentLessonData=function(a,b){if("activity"===a)k.getMaterial(b);
else{if("module"===a){var c=k.getMaterial(b);return k.getMaterial(c.parent_id)}return!1}};b.prototype.getParentActivityData=function(a){return k.getMaterial(a)};b.prototype.getGrader=function(a,b){return e.getGrader(a,b)};b.prototype.createGrader=function(a,b){return e.graderFactory(a,b)};b.prototype.sendEvent=function(a,b,c){l.emitEvent(a,b,c)};b.prototype.showNotification=function(a,b){l.showNotification(a,b)};b.prototype.parseCompleteCondition=function(a,b){var c=0;a=a.toString();if("%"===a.slice(a.length-
1))return c=parseInt(a.slice(0,a.length-1)),b.correct_percent>=c;c=parseInt(a);return b.correct_count>=c};b.prototype.conditionParser=function(a,b,c){var d=!1,e=0;"%"===a.slice(a.length-1)&&(d=!0);if("="===a.slice(1,2))return e=d?a.slice(2,a.length-1):a.slice(2),">"===a.slice(0,1)?d&&c>=e||!d&&b>=e:d&&c<=e||!d&&b<=e;e=d?a.slice(1,a.length-1):a.slice(1);return">"===a.slice(0,1)?d&&c>e||!d&&b>e:"<"===a.slice(0,1)?d&&c<e||!d&&b<e:d&&c==e||!d&&b==e};b.prototype.completeQuizActivity=function(a,b,c,d){if("undefined"!==
typeof a.jump){for(var e=[],g=0;g<a.jump.length;g++){var e=a.jump[g].split(":"),h=parseInt(100*c/a.problems.length);if("end_of_lesson_if_correctness"===e[0]&&this.conditionParser(e[1],c,h)||"to_activity_if_correctness"===e[0]&&this.conditionParser(e[2],c,h)||"force_to_activity"===e[0])break}g<a.jump.length?"end_of_lesson_if_correctness"!==e[0]?"undefined"==typeof a.show_summary||!a.show_summary||a.show_summary&&b.showQuizSummary?this.sendEvent("activityComplete_"+a.id,b,{activity:e[1],summary:d,should_transition:!0}):
this.sendEvent("activityComplete_"+a.id,b,{activity:e[1],summary:d,should_transition:!1}):"undefined"==typeof a.show_summary||!a.show_summary||a.show_summary&&b.showQuizSummary?this.sendEvent("endOfLesson",b,{summary:d,should_transition:!0}):this.sendEvent("endOfLesson",b,{summary:d,should_transition:!1}):"undefined"==typeof a.show_summary||!a.show_summary||a.show_summary&&b.showQuizSummary?this.sendEvent("activityComplete_"+a.id,b,{summary:d,should_transition:!0}):this.sendEvent("activityComplete_"+
a.id,b,{summary:d,should_transition:!1})}else"undefined"==typeof a.show_summary||!a.show_summary||a.show_summary&&b.showQuizSummary?this.sendEvent("activityComplete_"+a.id,b,{summary:d,should_transition:!0}):this.sendEvent("activityComplete_"+a.id,b,{summary:d,should_transition:!1})};b.prototype.problemGrader=function(a,b){if("singlechoice"===a.type){if("undefined"!==typeof b[a.id]){for(var c=0;c<a.choices.length&&b[a.id]!==a.choices[c].id;c++);return a.choices[c].is_correct}}else{if("singlefilling"===
a.type)return"undefined"!==typeof b[a.id]&&b[a.id]===a.correct_answer;for(var d=!0,c=0;c<a.choices.length;c++)if(a.choices[c].is_correct&&("undefined"===typeof b[a.choices[c].id]||!b[a.choices[c].id])){d=!1;break}return d}};b.prototype.playSoundEffects=function(a){(new Audio("resources/sound/"+a+".mp3")).play()}}return{getSandbox:function(){return new b}}}]);
